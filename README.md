# Recipol

Recipol links ISA-88 master recipes expressed in B2MML with Module Type Package (MTP) automation modules and executes the resulting sequence against OPC UA equipment. The project parses recipe intent, maps each step to available PEA services, and drives the plant equipment while logging telemetry.

## Key Capabilities
- **Recipe ingest**: Validates and parses BatchML/B2MML master recipes into a navigable graph of steps, transitions, resources, and parameters.
- **MTP interpretation**: Reads AML-based MTP manifests, extracts services, procedures, parameters, sensing/actuation interfaces, and OPC UA connectivity metadata.
- **Orchestration**: Aligns recipe steps with PEA procedures, enforces parameter bounds and units, and resolves required materials before executing.
- **OPC UA execution**: Issues state transitions and parameter updates to services through `asyncua`, with safety checks to recover from idle, completed, stopped, or aborted states.
- **Status logging**: Continuously records service states and sensor values in `DataHistory.csv` and prints ASCII sequence diagrams for operator awareness.

## Repository Layout
- `control.py` – Orchestrator; drives the recipe over OPC UA, logs data, and enforces transition conditions.
- `orchestration.py` – Maps B2MML steps to MTP procedures, building the linear/branched execution list.
- `b2mmlparser.py` – Parses and validates BatchML/B2MML recipes against `Schemas/AllSchemas.xsd`.
- `mtpparser.py` – Reads AML manifests, builds in-memory PEA objects, and collects OPC UA endpoints/namespaces.
- `sequenz.py` – Renders a text-based depiction of the active sequence step.
- `Artefakte/` – Sample B2MML recipes and AML manifests used during development.
- `Schemas/` – B2MML and BatchML schema bundle required for validation.
- `DataHistory.csv` – Rolling log generated by `control.py`; empty file acts as sink for new runs.

## Prerequisites
- Python 3.10 or newer (pattern matching used throughout the codebase).
- Access to the target OPC UA servers referenced by your MTP artefacts.
- Python packages: `asyncua`, `defusedxml`, `xmlschema`.

```bash
python -m venv .venv
source .venv/bin/activate
pip install asyncua defusedxml xmlschema
```

## Preparing Artefacts
1. **Master recipe**: Place your BatchML/B2MML XML (e.g., `Wabe102030_Grundrezept.xml`) under `Artefakte/` and update the `TESTXML*` constants in `b2mmlparser.py` to point to the desired file.
2. **MTP manifests**: Add AML files for each PEA under `Artefakte/` and edit `TESTMTPS` in `mtpparser.py` to list them in the execution order you need.
3. **OPC UA connectivity**: Ensure each AML file contains a `CommunicationSet` with an `Endpoint` and `Namespace`. The parser populates `Pea.url` and `Pea.ns` automatically.
4. **Initial data log**: Keep `DataHistory.csv` present and empty to allow the orchestrator to append headers and measurements.

## Running the Orchestrator
1. Activate your virtual environment and ensure dependencies are installed.
2. Populate or verify `Artefakte/` and `Schemas/` paths referenced by the parsers.
3. In `control.py`, set the global `url` and `ns` only if your MTP files do not carry OPC UA metadata (otherwise they are filled per PEA).
4. Execute the main controller:

```bash
python control.py
```

5. The script prints an ASCII flow of the recipe and pauses for operator confirmation before executing. Provide `y` to continue.
6. Monitor terminal output for state transitions; review `DataHistory.csv` for time-stamped states and sensor readings.

## Interpreting Outputs
- `DataHistory.csv` contains one row per sample with the time stamp followed by `<PEA>_<Service>` and `<PEA>_<Sensor>` columns.
- ASCII diagrams from `sequenz.drawSequenceDiagram` show the current step (`||` glyph) relative to overall flow.
- Any parameter violations or missing mappings raise runtime exceptions before execution begins.

## Extending & Roadmap
- Parallel procedure support and compound Boolean transition conditions are scaffolded but not yet implemented (`control.py` TODOs).
- Temperature-driven transitions and richer sensor types are partially stubbed in `readSensorValue`.
- Additional validation (e.g., ISA-95 material checks) can be added by extending `Requirement` parsing in `b2mmlparser.py`.

## Troubleshooting
- **Schema validation fails**: Confirm `Schemas/AllSchemas.xsd` matches the B2MML version of your recipe. Update the schema bundle if needed.
- **OPC UA writes rejected**: Verify the namespace index retrieved by `getNamespaceId` matches the server configuration; adjust `Pea.ns` or hardcode `nsid` if your server uses a dynamic namespace order.
- **Missing parameter IDs**: Ensure the parameter IDs in your recipe align with those exposed by the MTP procedure; the orchestrator enforces unit and range checks before execution.

## License
This project is licensed under the terms of the included `LICENSE` file (GNU GPL v3).
